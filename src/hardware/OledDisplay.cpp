#include "OledDisplay.h"
#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

static const unsigned char PROGMEM bootFrame1[] = {0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x04, 0x00, 0x10, 0x03, 0xff, 0xe0, 0x01, 0x00, 0x40, 0x01, 0x55, 0x40, 0x01, 0x2a, 0x40, 0x01, 0x14, 0x40, 0x00, 0x88, 0x80, 0x00, 0x41, 0x00, 0x00, 0x2a, 0x00, 0x00, 0x14, 0x00, 0x00, 0x14, 0x00, 0x00, 0x22, 0x00, 0x00, 0x49, 0x00, 0x00, 0x80, 0x80, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x03, 0xff, 0xe0, 0x04, 0x00, 0x10, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x00};

static const unsigned char PROGMEM bootFrame2[] = {0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x04, 0x00, 0x10, 0x03, 0xff, 0xe0, 0x01, 0x00, 0x40, 0x01, 0x7f, 0x40, 0x01, 0x7f, 0x40, 0x01, 0x3e, 0x40, 0x00, 0x9c, 0x80, 0x00, 0x49, 0x00, 0x00, 0x22, 0x00, 0x00, 0x14, 0x00, 0x00, 0x14, 0x00, 0x00, 0x22, 0x00, 0x00, 0x49, 0x00, 0x00, 0x80, 0x80, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x03, 0xff, 0xe0, 0x04, 0x00, 0x10, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x00};

static const unsigned char PROGMEM bootFrame3[] = {0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x04, 0x00, 0x10, 0x03, 0xff, 0xe0, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x7f, 0x40, 0x01, 0x3e, 0x40, 0x00, 0x9c, 0x80, 0x00, 0x49, 0x00, 0x00, 0x22, 0x00, 0x00, 0x14, 0x00, 0x00, 0x14, 0x00, 0x00, 0x22, 0x00, 0x00, 0x49, 0x00, 0x00, 0x80, 0x80, 0x01, 0x08, 0x40, 0x01, 0x3e, 0x40, 0x01, 0x7f, 0x40, 0x01, 0x00, 0x40, 0x03, 0xff, 0xe0, 0x04, 0x00, 0x10, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x00};

static const unsigned char PROGMEM bootFrame4[] = {0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x04, 0x00, 0x10, 0x03, 0xff, 0xe0, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x00, 0x40, 0x01, 0x3e, 0x40, 0x00, 0x9c, 0x80, 0x00, 0x49, 0x00, 0x00, 0x22, 0x00, 0x00, 0x14, 0x00, 0x00, 0x14, 0x00, 0x00, 0x22, 0x00, 0x00, 0x49, 0x00, 0x00, 0x80, 0x80, 0x01, 0x3e, 0x40, 0x01, 0x7f, 0x40, 0x01, 0x7f, 0x40, 0x01, 0x00, 0x40, 0x03, 0xff, 0xe0, 0x04, 0x00, 0x10, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x00};

static const unsigned char PROGMEM wifiNotConnected[] = {0x21, 0xf0, 0x00, 0x16, 0x0c, 0x00, 0x08, 0x03, 0x00, 0x25, 0xf0, 0x80, 0x42, 0x0c, 0x40, 0x89, 0x02, 0x20, 0x10, 0xa1, 0x00, 0x23, 0x58, 0x80, 0x04, 0x24, 0x00, 0x08, 0x52, 0x00, 0x01, 0xa8, 0x00, 0x02, 0x04, 0x00, 0x00, 0x42, 0x00, 0x00, 0xa1, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00};

static const unsigned char PROGMEM image_network_www_bits[] = {0x00, 0x0f, 0xf0, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0xf3, 0xcf, 0x00, 0x00, 0xf3, 0xcf, 0x00, 0x0f, 0x0c, 0x30, 0xf0, 0x0f, 0x0c, 0x30, 0xf0, 0x0c, 0x30, 0x0c, 0x30, 0x0c, 0x30, 0x0c, 0x30, 0x30, 0x30, 0x0c, 0x0c, 0x30, 0x30, 0x0c, 0x0c, 0x3f, 0xff, 0xff, 0xfc, 0x3f, 0xff, 0xff, 0xfc, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0xc0, 0xc0, 0x03, 0x03, 0x3f, 0xff, 0xff, 0xfc, 0x3f, 0xff, 0xff, 0xfc, 0x30, 0x30, 0x0c, 0x0c, 0x30, 0x30, 0x0c, 0x0c, 0x0c, 0x30, 0x0c, 0x30, 0x0c, 0x30, 0x0c, 0x30, 0x0f, 0x0c, 0x30, 0xf0, 0x0f, 0x0c, 0x30, 0xf0, 0x00, 0xf3, 0xcf, 0x00, 0x00, 0xf3, 0xcf, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x0f, 0xf0, 0x00};

static Adafruit_SSD1306 display(128, 64, &Wire);

OledDisplay::OledDisplay()
    : bootFrameIndex(0),
      lastBootFrameTime(0),
      bootStartTime(0),
      bootAnimationDone(false)
{
}

void OledDisplay::begin()
{
    Wire.begin(21, 22);
    display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(WHITE);
    display.display();
}

void OledDisplay::clear()
{
    display.clearDisplay();
    display.display();
}
void OledDisplay::onBootEnter()
{
    bootFrameIndex = 0;
    bootAnimationDone = false;
    lastBootFrameTime = millis();
    bootStartTime = millis();

    drawBootFrame(0);
}
void OledDisplay::drawBootFrame(uint8_t frame)
{
    display.clearDisplay();

    switch (frame)
    {
    case 0:
        display.drawBitmap(52, 20, bootFrame1, 24, 24, 1);
        break;

    case 1:
        display.drawBitmap(52, 20, bootFrame2, 24, 24, 1);
        break;

    case 2:
        display.drawBitmap(52, 20, bootFrame3, 24, 24, 1);
        break;

    case 3:
        display.drawBitmap(52, 20, bootFrame4, 24, 24, 1);
        break;

    case 4:
        display.setCursor(37, 28);
        display.print("BOOTING...");
        break;
    }

    display.display();
}
void OledDisplay::updateBoot()
{
    if (bootAnimationDone)
        return;

    unsigned long now = millis();

    if (now - lastBootFrameTime >= BOOT_FRAME_INTERVAL_MS)
    {
        lastBootFrameTime = now;
        bootFrameIndex++;

        if (bootFrameIndex < BOOT_FRAME_COUNT)
        {
            drawBootFrame(bootFrameIndex);
        }
        else
        {
            bootAnimationDone = true;
        }
    }
}
bool OledDisplay::isBootDone() const
{
    return bootAnimationDone &&
           (millis() - bootStartTime >= BOOT_MIN_TIME_MS);
}
void OledDisplay::drawSetupConfirmation()
{
    display.drawBitmap(109, 1, wifiNotConnected, 19, 16, 1);

    display.setTextSize(1);
    display.setTextColor(WHITE);
    display.setTextWrap(false);

    // ---- Centered title ----
    const char *title = "Enter Setup Mode?";
    int titleWidth = strlen(title) * 6;
    int titleX = (128 - titleWidth) / 2;

    display.setCursor(titleX, 26);
    display.print(title);

    // ---- Centered option 1 ----
    const char *opt1 = "LONG PRESS = Yes";
    int opt1Width = strlen(opt1) * 6;
    int opt1X = (128 - opt1Width) / 2;

    display.setCursor(opt1X, 38);
    display.print(opt1);

    // ---- Centered option 2 ----
    const char *opt2 = "SHORT PRESS = No";
    int opt2Width = strlen(opt2) * 6;
    int opt2X = (128 - opt2Width) / 2;

    display.setCursor(opt2X, 48);
    display.print(opt2);

    display.display();
}
void OledDisplay::drawSetupMode(const String &ip)
{
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setTextWrap(false);

    // ---- Title ----
    const char *title = "SETUP MODE";
    int titleX = (128 - strlen(title) * 6) / 2;
    display.setCursor(titleX, 0);
    display.print(title);

    // ---- Network Icon ----
    int iconX = (128 - 48) / 2;
    display.drawBitmap(iconX, 14, image_network_www_bits, 48, 48, 1);

    // ---- Instruction ----
    const char *hint = "Open in browser:";
    int hintX = (128 - strlen(hint) * 6) / 2;
    display.setCursor(hintX, 40);
    display.print(hint);

    // ---- IP Address (emphasis) ----
    int ipX = (128 - ip.length() * 6) / 2;
    display.setCursor(ipX, 52);
    display.print(ip);

    display.display();
}
void OledDisplay::drawError()
{
}